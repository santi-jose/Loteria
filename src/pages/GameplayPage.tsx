import { useState, useEffect } from "react";
import { useLocation } from "react-router-dom";
import DealerPanel from "../components/gameplay/DealerPanel";
import AIViewButtons from "../components/gameplay/AIViewButtons";
import cardData from "../data/cards.json";
import { cardImages } from "../assets/cards";
import ActiveCardPanel from "../components/gameplay/ActiveCardPanel";
import ViewPlayerButton from "../components/gameplay/ViewPlayerButton";
import PlayerOverlay from "../components/gameplay/overlays/PlayerOverlay";
import { Board } from "../game/Board";
import AIOverlay from "../components/gameplay/overlays/AIOverlay";

export default function GameplayPage(){
    const location = useLocation();
    const configuration = location.state;
    console.log(configuration);

    // const winCons = ["Row", "Column", "Diagonal", "Complete", "Pozo"];
    const winCons = useState(configuration.winCons);
    console.log(`winCons: ${winCons}`);

    // DealerPanel Props
    const [roundTimer, setRoundTimer] = useState(configuration.pace);
    const [deckCount, setDeckCount] = useState(53);
    const [discardPileCount, setDiscardPile] = useState(0);

    // AIViewButtons Props
    const [overlayAIActive, setOverlayAIView] = useState([false, false, false, false]);
    const handleViewAIClick = (id: number) => {
        console.log(`ViewAIButton${id} clicked`);
        const newOverlayAIView = overlayAIActive.map((AIActive, i) => {
            if((i+1) === id){
                return !AIActive;
            }else{
                return AIActive;
            }
        });
        setOverlayAIView(newOverlayAIView);
    }
    console.log(`overlayAIActive: ${overlayAIActive}`);

    // dummy card to represent active card
    const randomIndex = Math.floor(Math.random()*54);

    // ActiveCardPanel Props
    const [activeCard, setActiveCard] = useState(cardData[randomIndex]);

    // set AIPlayer count to 4
    const AIPlayerCount = 4;

    // ViewPlayerButton props
    const [overlayPlayerActive, setOverlayPlayerView] = useState(false);
    const handleViewPlayerClick = () => {
        console.log("ViewPlayerButton clicked");
        setOverlayPlayerView(!overlayPlayerActive);
    }
    console.log(`overlayPlayerActive: ${overlayPlayerActive}`);

    // PlayerOverlay Props

    // Board props
    // const dummyBoard = new Board();
    // const boardData = dummyBoard.

    // this board is the random board generated by the game logic
    // it will be connected from the game logic to here after completing UI
    // this random board definition is for UI purposes only
    const [board] = useState(new Board());
    const [aiBoards] = useState([
        new Board(), new Board(), new Board(), new Board()
    ]);

    const AI1Row1 = [];
    const AI1Row2 = [];
    const AI1Row3 = [];
    const AI1Row4 = [];

    const AI2Row1 = [];
    const AI2Row2 = [];
    const AI2Row3 = [];
    const AI2Row4 = [];

    const AI3Row1 = [];
    const AI3Row2 = [];
    const AI3Row3 = [];
    const AI3Row4 = [];

    const AI4Row1 = [];
    const AI4Row2 = [];
    const AI4Row3 = [];
    const AI4Row4 = [];

    const AIboard1 = aiBoards[0];
    const AIboard2 = aiBoards[1];
    const AIboard3 = aiBoards[2];
    const AIboard4 = aiBoards[3];

    for(let j = 0; j < 4; j++){
        AI1Row1.push(AIboard1.getTile(0, j));
        AI1Row2.push(AIboard1.getTile(1, j));
        AI1Row3.push(AIboard1.getTile(2, j));
        AI1Row4.push(AIboard1.getTile(3, j));

        AI2Row1.push(AIboard2.getTile(0, j));
        AI2Row2.push(AIboard2.getTile(1, j));
        AI2Row3.push(AIboard2.getTile(2, j));
        AI2Row4.push(AIboard2.getTile(3, j));

        AI3Row1.push(AIboard3.getTile(0, j));
        AI3Row2.push(AIboard3.getTile(1, j));
        AI3Row3.push(AIboard3.getTile(2, j));
        AI3Row4.push(AIboard3.getTile(3, j));

        AI4Row1.push(AIboard4.getTile(0, j));
        AI4Row2.push(AIboard4.getTile(1, j));
        AI4Row3.push(AIboard4.getTile(2, j));
        AI4Row4.push(AIboard4.getTile(3, j));
    }

    const AI1RowArrays = [[AI1Row1, AI1Row2, AI1Row3, AI1Row4],
                            [AI2Row1, AI2Row2, AI2Row3, AI2Row4],
                            [AI3Row1, AI3Row2, AI3Row3, AI3Row4],
                            [AI4Row1, AI4Row2, AI4Row3, AI4Row4]
    ];
    const [aiCardToggleGrid] = useState(
        [[[false, false, false, false],
         [false, false, false, false],
         [false, false, false, false],
         [false, false, false, false]
        ],
        [[false, false, false, false],
         [false, false, false, false],
         [false, false, false, false],
         [false, false, false, false]
        ],
        [[false, false, false, false],
         [false, false, false, false],
         [false, false, false, false],
         [false, false, false, false]
        ],
        [[false, false, false, false],
         [false, false, false, false],
         [false, false, false, false],
         [false, false, false, false]]]
    );
    
    const [aiActiveCardToggleGrid] = useState([
        [[true, true, true, true],
         [true, true, true, true],
         [true, true, true, true],
         [true, true, true, true]
        ],
        [[true, true, true, true],
         [true, true, true, true],
         [true, true, true, true],
         [true, true, true, true]
        ],
        [[true, true, true, true],
         [true, true, true, true],
         [true, true, true, true],
         [true, true, true, true]
        ],
        [[true, true, true, true],
         [true, true, true, true],
         [true, true, true, true],
         [true, true, true, true]]
    ]);

    const Row1 = [];
    const Row2 = [];
    const Row3 = [];
    const Row4 = [];

    // create rows of tiles
    for(let j = 0; j < 4; j++){
        Row1.push(board.getTile(0, j));
        Row2.push(board.getTile(1, j));
        Row3.push(board.getTile(2, j));
        Row4.push(board.getTile(3, j));
        // console.log(board.getTile(0,j).Card.Name)
        // console.log(board.getTile(1,j).Card.Name)
        // console.log(board.getTile(2,j).Card.Name)
        // console.log(board.getTile(3,j).Card.Name)
    }

    // create an array to store the row of tiles
    const rowArray = [Row1, Row2, Row3, Row4];

    // CardToggle props
    const [cardToggleGrid, setToggleGrid] = useState([
        [false, false, false, false],
        [false, false, false, false],
        [false, false, false, false],
        [false, false, false, false]
    ]);

    // CardToggle active prop
    const [activeCardToggleGrid, setActiveCardToggleGrid] = useState([
        [true, true, true, true],
        [true, true, true, true],
        [true, true, true, true],
        [true, true, true, true]
    ]);

    const handleToggleTile = (i: number, j: number) => {
        console.log(`Tile(${i}, ${j}) toggled!`);
        const newToggleGrid: boolean[][] = [];
        for(let row = 0; row <= 3; row++){
            const newToggleRow = [];
            for(let col = 0; col <= 3; col++){
                if((row === i) && (col === j)){
                    newToggleRow.push(!cardToggleGrid[row][col]);
                }else{
                    newToggleRow.push(cardToggleGrid[row][col]);
                }
            }
            newToggleGrid.push(newToggleRow);
        }

        // update cardToggleGrid state
        setToggleGrid(newToggleGrid);   
    }

    console.log(cardToggleGrid)

    return (
        <>
            <h1>GameplayPage</h1>
            {/* <h2>Configuration</h2>
            WinCons: 
            <ul>
            {configuration.winCons.map((winCon: boolean, i: number) => {
                return(
                    winCon ? <li>{winCons[i]}</li>: ""
                );
            })}
            </ul>
            Pace: {configuration.pace} */}
            <DealerPanel 
                roundTimer={roundTimer}
                deckCount={deckCount}
                discardPileCount={discardPileCount}
            />
            <div className="mainGamePanel">
                <AIViewButtons 
                    onViewAIClick={handleViewAIClick}
                    AIPlayerCount={AIPlayerCount}
                />
                <ActiveCardPanel 
                    id={activeCard.id}
                    name={activeCard.name}
                    description={activeCard.description}
                    image={cardImages[activeCard.id]}
                />
            </div>
            <ViewPlayerButton 
                onViewPlayerClick={handleViewPlayerClick}
            />
            {overlayPlayerActive && 
            <PlayerOverlay 
                rowArray={rowArray}
                cardToggleGrid={cardToggleGrid}
                activeCardToggleGrid={activeCardToggleGrid}
                onToggleCard={handleToggleTile}
            />}
            {overlayAIActive.map((overlayActive, i) => {
                return(overlayActive && <AIOverlay id={i + 1} rowArray={AI1RowArrays[i]}
                cardToggleGrid={aiCardToggleGrid[i]} activeCardToggleGrid={aiActiveCardToggleGrid[i]}/>)
            })
            }
        </>
    );
}